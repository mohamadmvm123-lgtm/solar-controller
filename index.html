<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>اپ موبایلی دمو - کنترل خورشیدی پیشرفته + اتصالات</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0b1020; --bg2:#1f2341; --bg3:#0f172a;
      --glass:#ffffff18; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --primary:#38bdf8; --accent:#a78bfa;
    }
    html,body{height:100%}
    body{
      font-family:"Vazirmatn",system-ui,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(800px 500px at 90% -10%, #1e3a8a55 10%, transparent 60%),
        radial-gradient(900px 600px at -10% 20%, #0ea5e944 10%, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 45%, var(--bg3));
      color:#f8fafc;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      overscroll-behavior-y: none;
    }
    .app-shell{max-width:720px;margin:0 auto}
    .glass{background:linear-gradient(180deg,#ffffff1a,#ffffff0d);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--glass);box-shadow:0 8px 24px #0006,inset 0 1px 0 #ffffff22;border-radius:1rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;padding:1rem 1.1rem;border-radius:1.1rem;font-weight:800;background:linear-gradient(180deg,#ffffff22,#ffffff10);border:1px solid #ffffff33;transition:transform .15s,box-shadow .15s,opacity .15s}
    .btn:active{transform:scale(.98)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:linear-gradient(180deg,#38bdf8,#0284c7);border-color:#7dd3fc}
    .btn-danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#f87171}
    .btn-ghost{background:transparent;border-color:#ffffff33}
    .badge{padding:.26rem .6rem;border-radius:999px;font-size:.75rem;font-weight:800;border:1px solid #ffffff33}
    .status-dot{width:.6rem;height:.6rem;border-radius:999px;display:inline-block;margin-left:.4rem;box-shadow:0 0 0 3px #ffffff10,0 0 16px currentColor}
    .chip{padding:.38rem .7rem;border-radius:.7rem;border:1px dashed #ffffff33}
    .modal-backdrop{background:#0b1020cc}
    .nav-item{color:#cbd5e1}
    .nav-item.active{color:#ffffff}
    .range{accent-color:#38bdf8}
    .safe-area{padding-bottom: env(safe-area-inset-bottom)}
    .tab-hide{display:none}
    .chart-grid line{stroke:#ffffff22}
    #logList{overscroll-behavior: contain}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .inp{background-color:#ffffff0d;border:1px solid #ffffff22;border-radius:.8rem;padding:.65rem .8rem;outline:none}
    .inp:focus{box-shadow:0 0 0 2px #38bdf888;border-color:#7dd3fc}
    .number::-webkit-outer-spin-button,.number::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .card-h{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .subtle{color:#cbd5e1}
    .note{font-size:.8rem;color:#cbd5e1}
    .pill{border-radius:999px;padding:.25rem .6rem;border:1px solid #ffffff30}
  </style>
</head>
<body>
  <div class="min-h-screen app-shell flex flex-col">
    <!-- App Bar -->
    <header class="px-4 pt-6 pb-1">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 glass grid place-items-center rounded-xl">
            <!-- sun + panel -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="6" cy="6" r="3" stroke="#fde68a" stroke-width="2"/>
              <path d="M3 21h18M4 21l3-8h6l-3 8M11 13l3-8h6l-3 8" stroke="#93c5fd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="leading-tight">
            <div class="flex items-center gap-2">
              <h1 id="siteTitle" class="text-lg font-extrabold">کنترل خورشیدی (موبایل)</h1>
              <span class="badge" style="background:#f59e0b22;color:#fde68a;border-color:#f59e0b55">دمو</span>
            </div>
            <p class="text-slate-300 text-xs">بدون اتصال واقعی • فقط شبیه‌ساز</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="modePill" class="pill text-xs subtle">حالت: شبیه‌ساز</span>
          <button id="btnSafety" class="btn btn-danger text-sm px-3" title="قفل ایمنی">
            <svg id="lockIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 10V8a5 5 0 0 1 10 0v2M6 10h12v9a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-9z" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
            </svg>
            قفل ایمنی فعال
          </button>
        </div>
      </div>
      <div id="installBar" class="mt-2 mx-4 hidden">
        <div class="glass p-3 flex items-center justify-between gap-3 rounded-xl">
          <div class="text-xs text-slate-200 leading-tight">
            <div class="font-extrabold">نصب به صفحه‌اصلی</div>
            <div class="opacity-80">برای دسترسی سریع در موبایل</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnInstall" class="btn btn-primary text-xs px-3">نصب</button>
            <button id="btnDismissInstall" class="btn btn-ghost text-xs px-3">بی‌خیال</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="flex-1 px-4 pb-28" style="scroll-behavior:smooth">
      <!-- Dashboard -->
      <section id="screen-dashboard" class="space-y-4">
        <div id="alarmBanner" class="glass p-3 text-amber-100 border border-amber-400/40 hidden" style="background:linear-gradient(90deg,#f59e0b22,#f59e0b11)">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="status-dot" style="color:var(--warn)"></span>
              <p id="alarmText" class="text-sm">آلارم فعال</p>
            </div>
            <button id="btnMuteAlarms" class="btn btn-ghost text-xs px-3">سکوت</button>
          </div>
        </div>

        <div class="glass p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span id="dotStatus" class="status-dot" style="color:var(--ok)"></span>
              <h2 class="font-extrabold">وضعیت سیستم</h2>
            </div>
            <span id="txtLast" class="text-slate-300 text-xs">—</span>
          </div>
          <p id="txtStatus" class="text-slate-200 mt-1 text-sm">پایدار</p>
          <div class="mt-3 flex flex-wrap gap-2 text-sm">
            <span id="badgeGrid" class="badge">شبکه: متصل</span>
            <span id="badgeInv" class="badge">اینورتر: سالم</span>
            <span id="badgeTemp" class="badge">دما: ۳۶°C</span>
          </div>
        </div>

        <div class="glass p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-extrabold">توان لحظه‌ای</h3>
            <div class="text-2xl font-extrabold"><span id="txtPower">۴۲۰۰</span> <span class="text-slate-300 text-sm">وات</span></div>
          </div>
          <div class="mt-3 chip text-sm">تابش خورشید: <span id="txtIrr">۸۰٪</span></div>
          <div class="mt-4">
            <label for="rngIrr" class="text-xs text-slate-300 block mb-2">تنظیم تابش (ابر/آفتاب)</label>
            <input id="rngIrr" class="w-full range" type="range" min="0" max="100" value="80">
          </div>
        </div>

        <div class="glass p-4">
          <h3 class="font-extrabوذ mb-2">نمودار توان</h3>
          <svg id="chart" viewBox="0 0 360 140" class="w-full h-[140px] select-none">
            <g class="chart-grid">
              <line x1="0" y1="120" x2="360" y2="120"></line>
              <line x1="0" y1="90" x2="360" y2="90"></line>
              <line x1="0" y1="60" x2="360" y2="60"></line>
              <line x1="0" y1="30" x2="360" y2="30"></line>
            </g>
            <path id="chartPath" d="" fill="url(#grad)" stroke="#38bdf8" stroke-width="2"/>
            <defs>
              <linearGradient id="grad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#38bdf8" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#38bdf8" stop-opacity="0"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
      </section>

      <!-- Controls -->
      <section id="screen-controls" class="space-y-4 tab-hide">
        <div id="safetyBanner" class="glass p-3 text-amber-100 border border-amber-400/40 hidden" style="background:linear-gradient(90deg,#f59e0b22,#f59e0b11)">
          برای اجرای فرمان‌ها، ابتدا قفل ایمنی را باز کنید.
        </div>

        <div class="glass p-4">
          <h3 class="font-extrabold mb-3">فرمان‌های اصلی</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <button class="btn btn-danger" data-action="cut_grid">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18 18 6M6 6l12 12" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
              قطع اتصال شبکه
            </button>
            <button class="btn" data-action="inv_fault">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.3 3.86 1.82 19a2 2 0 0 0 1.73 3h16.9a2 2 0 0 0 1.73-3L13.7 3.86a2 2 0 0 0-3.4 0z" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
              خطای اینورتر
            </button>
            <button class="btn" data-action="reduce_power">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 8v8m-4-4h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
              کاهش توان (۱۲۰۰W)
            </button>
            <button class="btn btn-primary" data-action="reset">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-2.64-6.36M21 3v6h-6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
              ریست سیستم
            </button>
          </div>
        </div>

        <div class="glass p-4">
          <h3 class="font-extrabold mb-3">تنظیم توان دلخواه</h3>
          <form id="customPowerForm" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="field sm:col-span-2">
              <label for="inpPower" class="text-xs text-slate-300">توان هدف (وات)</label>
              <input id="inpPower" type="number" inputmode="numeric" class="inp number" min="0" max="5000" step="100" placeholder="مثال: 3000">
            </div>
            <div class="flex items-end">
              <button id="btnSetPower" class="btn btn-primary w-full" type="submit">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4L19 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
                اعمال توان
              </button>
            </div>
          </form>
          <p class="text-slate-300 text-xs mt-2">برای اعمال، تأیید لازم است و در لاگ ثبت می‌شود.</p>
        </div>
      </section>

      <!-- Logs -->
      <section id="screen-logs" class="space-y-3 tab-hide">
        <div class="flex items-center justify-between gap-2">
          <h3 class="font-extrabold">لاگ رخداد</h3>
          <div class="flex items-center gap-2">
            <button id="btnCopyLog" class="btn btn-ghost text-sm px-3">کپی</button>
            <button id="btnDownload" class="btn btn-ghost text-sm px-3">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0 4-4m-4 4-4-4M5 21h14" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
              دانلود
            </button>
            <button id="btnClearLog" class="btn btn-ghost text-sm px-3">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M10 11v6M14 11v6M6 7l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
              پاک‌سازی
            </button>
          </div>
        </div>

        <div class="glass p-3">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="field md:col-span-2">
              <label for="inpSearch" class="text-xs text-slate-300">جستجو</label>
              <input id="inpSearch" class="inp" placeholder="جستجو در عملیات/نتیجه/توضیح">
            </div>
            <div class="flex flex-wrap gap-2 items-end md:col-span-2">
              <button class="btn btn-ghost text-sm px-3 filter-btn active" data-filter="all">همه</button>
              <button class="btn btn-ghost text-sm px-3 filter-btn" data-filter="cmd">فرمان‌ها</button>
              <button class="btn btn-ghost text-sm px-3 filter-btn" data-filter="warn">هشدار</button>
              <button class="btn btn-ghost text-sm px-3 filter-btn" data-filter="err">خطا</button>
            </div>
          </div>
        </div>

        <div class="glass overflow-hidden">
          <div id="logList" class="max-h-[60vh] overflow-auto divide-y divide-white/10" role="log" aria-live="polite"></div>
        </div>
      </section>

      <!-- Settings -->
      <section id="screen-settings" class="space-y-4 tab-hide">
        <div class="glass p-4">
          <h3 class="font-extrabold mb-3">تنظیمات عمومی</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="field">
              <label for="inpSite" class="text-xs text-slate-300">نام سایت/پروژه</label>
              <input id="inpSite" class="inp" placeholder="مثال: نیروگاه شیراز">
            </div>
            <div class="field">
              <label for="rngTick" class="text-xs text-slate-300">سرعت به‌روزرسانی (میلی‌ثانیه): <span id="lblTick">1200</span></label>
              <input id="rngTick" type="range" min="600" max="3000" step="100" value="1200" class="range">
            </div>
            <div class="field">
              <label for="rngMaxPower" class="text-xs text-slate-300">حداکثر توان مجاز سیستم: <span id="lblMaxPower">5000 W</span></label>
              <input id="rngMaxPower" type="range" min="1000" max="5000" step="100" value="5000" class="range">
            </div>
            <div class="field">
              <label for="rngTempAlarm" class="text-xs text-slate-300">آستانه آلارم دما: <span id="lblTempAlarm">60°C</span></label>
              <input id="rngTempAlarm" type="range" min="30" max="80" step="1" value="60" class="range">
            </div>
            <label class="inline-flex items-center gap-2 mt-2">
              <input id="chkAutosave" type="checkbox" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">ذخیره خودکار تنظیمات</span>
            </label>
          </div>
          <p class="note mt-2">نکته: این دمو هیچ اطلاعات حساس/رمز عبوری جمع‌آوری نمی‌کند.</p>
        </div>

        <div class="glass p-4">
          <h3 class="font-extrabold mb-3">پشتیبان‌گیری و بازیابی</h3>
          <div class="flex flex-wrap gap-3">
            <button id="btnExportCfg" class="btn btn-ghost">خروجی JSON</button>
            <label class="btn btn-ghost cursor-pointer">
              ورود JSON
              <input id="fileImport" type="file" accept="application/json" class="hidden">
            </label>
            <button id="btnResetCfg" class="btn btn-danger">بازنشانی به پیش‌فرض</button>
          </div>
          <p class="text-slate-300 text-xs mt-2">تنظیمات در مرورگر شما ذخیره می‌شوند.</p>
        </div>
      </section>

      <!-- Connections -->
      <section id="screen-connections" class="space-y-4 tab-hide">
        <div class="glass p-4">
          <div class="card-h">
            <h3 class="font-extrabold">اتصالات واقعی (API واحد)</h3>
            <span class="pill text-xs subtle">Modbus • 61850 • OPC UA • DNP3/104 • MQTT</span>
          </div>
          <p class="note mt-2">این بخش برای اتصال به درگاه میانی شماست. در این دمو، تست‌ها شبیه‌سازی می‌شوند.</p>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="inline-flex items-center gap-2">
              <input id="chkUseReal" type="checkbox" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">استفاده از API واقعی به‌جای شبیه‌ساز</span>
            </label>
            <div class="flex items-center gap-2">
              <button id="btnApiTest" class="btn btn-ghost text-sm">تست API</button>
              <button id="btnApiSave" class="btn btn-primary text-sm">ذخیره</button>
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">آدرس API (REST)</label>
              <input id="inpApiBase" class="inp" placeholder="https://edge.local:8443/api">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">آدرس WS (اختیاری)</label>
              <input id="inpWsUrl" class="inp" placeholder="wss://edge.local:8443/ws">
            </div>
          </div>
        </div>

        <!-- Modbus -->
        <div class="glass p-4" data-conn-card="modbus">
          <div class="card-h">
            <div class="flex items-center gap-2">
              <h4 class="font-extrabold">Modbus</h4>
              <span id="st_modbus" class="pill text-xs subtle">غیرفعال</span>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-conn-enabled="modbus" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">فعال</span>
            </label>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-3" data-conn-form="modbus">
            <div class="field md:col-span-2">
              <label class="text-xs text-slate-300">Host/IP</label>
              <input class="inp" data-conn-field="host" placeholder="192.168.1.10">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">Port</label>
              <input class="inp number" type="number" min="1" max="65535" step="1" data-conn-field="port" placeholder="502">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">Unit ID</label>
              <input class="inp number" type="number" min="1" max="247" step="1" data-conn-field="unitId" placeholder="1">
            </div>
            <div class="field md:col-span-2">
              <label class="text-xs text-slate-300">حالت</label>
              <select class="inp" data-conn-field="mode">
                <option value="tcp">TCP</option>
                <option value="rtu">RTU (از طریق گیت‌وی)</option>
              </select>
            </div>
            <div class="flex items-end gap-2 md:col-span-2">
              <button class="btn btn-ghost text-sm" data-conn-test="modbus">تست اتصال</button>
              <button class="btn btn-primary text-sm" data-conn-save="modbus">ذخیره</button>
            </div>
          </div>
          <p class="note mt-2">نکته: این دمو اطلاعات ورود حساس را جمع‌آوری نمی‌کند.</p>
        </div>

        <!-- IEC 61850 -->
        <div class="glass p-4" data-conn-card="iec61850">
          <div class="card-h">
            <div class="flex items-center gap-2">
              <h4 class="font-extrabold">IEC 61850</h4>
              <span id="st_iec61850" class="pill text-xs subtle">غیرفعال</span>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-conn-enabled="iec61850" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">فعال</span>
            </label>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-3" data-conn-form="iec61850">
            <div class="field">
              <label class="text-xs text-slate-300">Host/IP</label>
              <input class="inp" data-conn-field="host" placeholder="10.0.0.5">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">Port</label>
              <input class="inp number" type="number" data-conn-field="port" placeholder="102">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">IED</label>
              <input class="inp" data-conn-field="ied" placeholder="IED1">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">LD</label>
              <input class="inp" data-conn-field="ld" placeholder="LD0">
            </div>
            <div class="flex items-end gap-2 md:col-span-2">
              <button class="btn btn-ghost text-sm" data-conn-test="iec61850">تست اتصال</button>
              <button class="btn btn-primary text-sm" data-conn-save="iec61850">ذخیره</button>
            </div>
          </div>
        </div>

        <!-- OPC UA -->
        <div class="glass p-4" data-conn-card="opcua">
          <div class="card-h">
            <div class="flex items-center gap-2">
              <h4 class="font-extrabold">OPC UA</h4>
              <span id="st_opcua" class="pill text-xs subtle">غیرفعال</span>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-conn-enabled="opcua" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">فعال</span>
            </label>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3" data-conn-form="opcua">
            <div class="field md:col-span-2">
              <label class="text-xs text-slate-300">Endpoint URL</label>
              <input class="inp" data-conn-field="endpoint" placeholder="opc.tcp://localhost:4840">
            </div>
            <div class="flex items-end gap-2">
              <button class="btn btn-ghost text-sm" data-conn-test="opcua">تست اتصال</button>
              <button class="btn btn-primary text-sm" data-conn-save="opcua">ذخیره</button>
            </div>
          </div>
          <p class="note mt-2">احراز هویت پیشرفته را در گیت‌وی تنظیم کنید.</p>
        </div>

        <!-- DNP3 -->
        <div class="glass p-4" data-conn-card="dnp3">
          <div class="card-h">
            <div class="flex items-center gap-2">
              <h4 class="font-extrabold">DNP3</h4>
              <span id="st_dnp3" class="pill text-xs subtle">غیرفعال</span>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-conn-enabled="dnp3" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">فعال</span>
            </label>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-3" data-conn-form="dnp3">
            <div class="field md:col-span-2">
              <label class="text-xs text-slate-300">Outstation</label>
              <input class="inp" data-conn-field="outstation" placeholder="10.0.0.20">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">Master</label>
              <input class="inp" data-conn-field="master" placeholder="10.0.0.2">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">Port</label>
              <input class="inp number" type="number" data-conn-field="port" placeholder="20000">
            </div>
            <div class="flex items-end gap-2 md:col-span-2">
              <button class="btn btn-ghost text-sm" data-conn-test="dnp3">تست اتصال</button>
              <button class="btn btn-primary text-sm" data-conn-save="dnp3">ذخیره</button>
            </div>
          </div>
        </div>

        <!-- IEC 60870-5-104 -->
        <div class="glass p-4" data-conn-card="iec104">
          <div class="card-h">
            <div class="flex items-center gap-2">
              <h4 class="font-extrabold">IEC 60870-5-104</h4>
              <span id="st_iec104" class="pill text-xs subtle">غیرفعال</span>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-conn-enabled="iec104" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">فعال</span>
            </label>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-3" data-conn-form="iec104">
            <div class="field md:col-span-2">
              <label class="text-xs text-slate-300">Host/IP</label>
              <input class="inp" data-conn-field="host" placeholder="10.0.0.30">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">Port</label>
              <input class="inp number" type="number" data-conn-field="port" placeholder="2404">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">ASDU</label>
              <input class="inp number" type="number" data-conn-field="asdu" placeholder="1">
            </div>
            <div class="flex items-end gap-2 md:col-span-2">
              <button class="btn btn-ghost text-sm" data-conn-test="iec104">تست اتصال</button>
              <button class="btn btn-primary text-sm" data-conn-save="iec104">ذخیره</button>
            </div>
          </div>
        </div>

        <!-- MQTT -->
        <div class="glass p-4" data-conn-card="mqtt">
          <div class="card-h">
            <div class="flex items-center gap-2">
              <h4 class="font-extrabold">MQTT</h4>
              <span id="st_mqtt" class="pill text-xs subtle">غیرفعال</span>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-conn-enabled="mqtt" class="w-5 h-5 accent-[#22c55e]">
              <span class="text-sm">فعال</span>
            </label>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3" data-conn-form="mqtt">
            <div class="field md:col-span-2">
              <label class="text-xs text-slate-300">Broker URL</label>
              <input class="inp" data-conn-field="broker" placeholder="mqtts://broker.local:8883">
            </div>
            <div class="field">
              <label class="text-xs text-slate-300">Topic</label>
              <input class="inp" data-conn-field="topic" placeholder="plant/+/telemetry">
            </div>
            <div class="flex items-end gap-2">
              <button class="btn btn-ghost text-sm" data-conn-test="mqtt">تست اتصال</button>
              <button class="btn btn-primary text-sm" data-conn-save="mqtt">ذخیره</button>
            </div>
          </div>
          <p class="note mt-2">اعتبارنامه‌ها را در گیت‌وی امن نگه‌داری کنید (اینجا ذخیره نمی‌شوند).</p>
        </div>
      </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 safe-area" style="backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);">
      <div class="app-shell mx-auto px-4 pb-3">
        <div class="glass grid grid-cols-5 p-2 rounded-2xl">
          <button class="nav-item active flex flex-col items-center py-2" data-nav="dashboard" aria-label="داشبورد">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h7V3H3v9Zm0 9h7v-7H3v7Zm11 0h7V12h-7v9Zm0-18v7h7V3h-7Z" stroke="currentColor" stroke-width="2"/></svg>
            <span class="text-xs mt-1">داشبورد</span>
          </button>
          <button class="nav-item flex flex-col items-center py-2" data-nav="controls" aria-label="فرمان‌ها">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span class="text-xs mt-1">فرمان‌ها</span>
          </button>
          <button class="nav-item flex flex-col items-center py-2" data-nav="logs" aria-label="لاگ">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M7 4h10a2 2 0 0 1 2 2v12l-4-3-4 3-4-3-4 3V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span class="text-xs mt-1">لاگ</span>
          </button>
          <button class="nav-item flex flex-col items-center py-2" data-nav="connections" aria-label="اتصالات">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 17h16M8 7v10m8-10v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span class="text-xs mt-1">اتصالات</span>
          </button>
          <button class="nav-item flex flex-col items-center py-2" data-nav="settings" aria-label="تنظیمات">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="m12 15 3 3m-3-3-3 3M12 9l3-3m-3 3-3-3M3 12h3m12 0h3M4.5 7.5l2.1 1.2M19.5 16.5l-2.1-1.2M4.5 16.5l2.1-1.2M19.5 7.5l-2.1 1.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <span class="text-xs mt-1">تنظیمات</span>
          </button>
        </div>
      </div>
    </nav>
  </div>

  <!-- Confirm Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative glass w-[92%] max-w-md p-5">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="flex items-center gap-2">
            <span id="modalDot" class="status-dot" style="color:var(--warn)"></span>
            <h3 class="text-lg font-extrabold">تأیید عملیات</h3>
          </div>
          <p id="modalSub" class="text-slate-300 mt-1 text-xs">قبل از اجرا، تأیید کنید.</p>
        </div>
        <button id="modalClose" class="btn btn-ghost !p-2" aria-label="بستن">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="mt-3 space-y-3">
        <div class="chip text-sm">عملیات: <span id="modalAction" class="font-bold"></span></div>
        <label class="flex items-start gap-3 cursor-pointer select-none text-sm">
          <input id="chkConfirm" type="checkbox" class="mt-1 w-5 h-5 accent-[#22c55e]">
          <span>مسئولیت این عملیات را می‌پذیرم.</span>
        </label>
        <div>
          <label for="txtNote" class="text-xs text-slate-300 mb-1 block">توضیح (اختیاری)</label>
          <textarea id="txtNote" rows="3" class="w-full rounded-lg bg-white/5 border border-white/20 p-3 outline-none focus:ring-2 focus:ring-sky-400" placeholder="مثال: تست شیفت صبح"></textarea>
        </div>
        <p id="modalErr" class="text-rose-300 text-xs hidden">برای ادامه، تیک تأیید را بزنید.</p>
      </div>
      <div class="mt-4 flex items-center justify-between">
        <button id="modalCancel" class="btn btn-ghost text-sm">انصراف</button>
        <button id="modalOk" class="btn btn-primary text-sm">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="m5 12 4 4L19 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
          اجرا
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 left-4 md:left-auto md:right-6 z-[60] hidden">
    <div id="toastInner" class="glass px-4 py-3 flex items-center gap-3 border-l-4" style="border-color:var(--ok)">
      <span id="toastDot" class="status-dot" style="color:var(--ok)"></span>
      <p id="toastMsg" class="text-slate-100">انجام شد</p>
    </div>
  </div>

  <script>
    // --- State ---
    const state = {
      safety: true,
      irradiance: 0.8,   // 0..1
      temp: 36,          // °C
      grid: 'متصل',      // متصل | قطع
      inverter: 'سالم',  // سالم | معیوب
      status: 'پایدار',
      powerTarget: 4200,
      powerNow: 4200,
      chart: [],
      logs: [],
      alarms: {
        active: [], // {id, title, type}
        muted: false
      },
      cfg: {
        siteName: 'کنترل خورشیدی (موبایل)',
        tickMs: 1200,
        maxPower: 5000,
        tempAlarm: 60,
        autosave: true,
        useRealApi: false,
        apiBase: '',
        wsUrl: '',
        connections: {
          modbus: { enabled:false, host:'', port:502, unitId:1, mode:'tcp' },
          iec61850: { enabled:false, host:'', port:102, ied:'', ld:'' },
          opcua: { enabled:false, endpoint:'' },
          dnp3: { enabled:false, outstation:'', master:'', port:20000 },
          iec104: { enabled:false, host:'', port:2404, asdu:1 },
          mqtt: { enabled:false, broker:'', topic:'' } // بدون جمع‌آوری اعتبارنامه
        }
      }
    };

    // --- Elements ---
    const el = {
      // screens
      scrDash: document.getElementById('screen-dashboard'),
      scrCtrl: document.getElementById('screen-controls'),
      scrLogs: document.getElementById('screen-logs'),
      scrSettings: document.getElementById('screen-settings'),
      scrConnections: document.getElementById('screen-connections'),
      // nav
      navButtons: document.querySelectorAll('[data-nav]'),
      // alarm
      alarmBanner: document.getElementById('alarmBanner'),
      alarmText: document.getElementById('alarmText'),
      btnMuteAlarms: document.getElementById('btnMuteAlarms'),
      // overview
      siteTitle: document.getElementById('siteTitle'),
      modePill: document.getElementById('modePill'),
      dotStatus: document.getElementById('dotStatus'),
      txtStatus: document.getElementById('txtStatus'),
      txtLast: document.getElementById('txtLast'),
      badgeGrid: document.getElementById('badgeGrid'),
      badgeInv: document.getElementById('badgeInv'),
      badgeTemp: document.getElementById('badgeTemp'),
      txtPower: document.getElementById('txtPower'),
      txtIrr: document.getElementById('txtIrr'),
      rngIrr: document.getElementById('rngIrr'),
      // safety
      btnSafety: document.getElementById('btnSafety'),
      safetyBanner: document.getElementById('safetyBanner'),
      // chart
      chartPath: document.getElementById('chartPath'),
      // controls
      customPowerForm: document.getElementById('customPowerForm'),
      inpPower: document.getElementById('inpPower'),
      // logs
      logList: document.getElementById('logList'),
      btnDownload: document.getElementById('btnDownload'),
      btnClearLog: document.getElementById('btnClearLog'),
      btnCopyLog: document.getElementById('btnCopyLog'),
      inpSearch: document.getElementById('inpSearch'),
      filterBtns: document.querySelectorAll('.filter-btn'),
      // settings
      inpSite: document.getElementById('inpSite'),
      rngTick: document.getElementById('rngTick'),
      lblTick: document.getElementById('lblTick'),
      rngMaxPower: document.getElementById('rngMaxPower'),
      lblMaxPower: document.getElementById('lblMaxPower'),
      rngTempAlarm: document.getElementById('rngTempAlarm'),
      lblTempAlarm: document.getElementById('lblTempAlarm'),
      chkAutosave: document.getElementById('chkAutosave'),
      btnExportCfg: document.getElementById('btnExportCfg'),
      btnResetCfg: document.getElementById('btnResetCfg'),
      fileImport: document.getElementById('fileImport'),
      // connections (generic)
      chkUseReal: document.getElementById('chkUseReal'),
      inpApiBase: document.getElementById('inpApiBase'),
      inpWsUrl: document.getElementById('inpWsUrl'),
      btnApiTest: document.getElementById('btnApiTest'),
      btnApiSave: document.getElementById('btnApiSave')
    };

    // --- Helpers ---
    const faNum = (n)=> (typeof n==='number'? n : Number(n)).toLocaleString('fa-IR');
    const nowFa = ()=> new Date().toLocaleTimeString('fa-IR');

    function showToast(message, type='ok'){
      const map = { ok:'var(--ok)', warn:'var(--warn)', err:'var(--err)' };
      el.toastMsg.textContent = message;
      el.toastInner.style.borderColor = map[type];
      el.toastDot.style.color = map[type];
      el.toast.classList.remove('hidden');
      clearTimeout(el.toast._t);
      el.toast._t = setTimeout(()=> el.toast.classList.add('hidden'), 2200);
    }

    function addLog(action, result, note='', type='info'){
      const entry = {
        id: 'log_' + Date.now() + '_' + Math.random().toString(36).slice(2,7),
        t: new Date(),
        action, result, note, type
      };
      state.logs.unshift(entry);
      if (state.logs.length > 600) state.logs.pop();
      renderLogEntry(entry, true);
      if (state.cfg.autosave) saveLocal();
    }

    function renderLogEntry(entry, prepend=false){
      const row = document.createElement('div');
      row.className = 'p-3 hover:bg-white/5 transition-colors';
      row.setAttribute('data-id', entry.id);
      row.setAttribute('data-type', entry.type);
      const color = entry.type==='err' ? '#fecaca' : entry.type==='warn' ? '#fde68a' : entry.type==='cmd' ? '#bfdbfe' : '#e5e7eb';
      row.innerHTML = `
        <div class="flex flex-col gap-1">
          <div class="flex items-center justify-between">
            <span class="badge" style="background:${color}22;border-color:${color}55;color:${color}">${entry.action}</span>
            <span class="text-slate-400 text-xs">${entry.t.toLocaleString('fa-IR')}</span>
          </div>
          <div class="text-slate-300 text-sm">
            <span class="opacity-80">نتیجه:</span> ${entry.result}
            ${entry.note ? `<span class="opacity-70 mx-2">|</span><span class="opacity-90">توضیح:</span> ${entry.note}`:''}
          </div>
        </div>
      `;
      if (prepend) el.logList.prepend(row); else el.logList.appendChild(row);
    }

    function applyLogFilters(){
      const term = (el.inpSearch?.value || '').trim();
      const filter = document.querySelector('.filter-btn.active')?.getAttribute('data-filter') || 'all';
      const items = el.logList.children;
      const re = term ? new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i') : null;
      for (const it of items){
        const type = it.getAttribute('data-type');
        const text = it.textContent || '';
        const typeOk = (filter==='all' || filter===type);
        const termOk = (!re || re.test(text));
        it.style.display = (typeOk && termOk) ? '' : 'none';
      }
    }

    function updateOverview(){
      let status = 'پایدار', dot = 'var(--ok)';
      if (state.inverter === 'معیوب') { status = 'هشدار - اینورتر'; dot = 'var(--warn)'; }
      if (state.grid === 'قطع') { status = 'حالت جزیره‌ای'; dot = 'var(--warn)'; }
      if (state.inverter === 'معیوب' && state.grid === 'قطع') { status = 'خطا - بررسی فوری'; dot = 'var(--err)'; }

      state.status = status;
      el.txtStatus.textContent = status;
      el.dotStatus.style.color = dot;
      el.badgeGrid.textContent = `شبکه: ${state.grid}`;
      el.badgeInv.textContent = `اینورتر: ${state.inverter}`;
      el.badgeTemp.textContent = `دما: ${faNum(Math.round(state.temp))}°C`;
      el.txtPower.textContent = faNum(Math.max(0, Math.round(state.powerNow)));
      el.txtIrr.textContent = `${Math.round(state.irradiance*100)}٪`;
      el.txtLast.textContent = nowFa();
      el.siteTitle.textContent = state.cfg.siteName || 'کنترل خورشیدی (موبایل)';
      el.modePill.textContent = `حالت: ${state.cfg.useRealApi ? 'API واقعی' : 'شبیه‌ساز'}`;
      el.modePill.style.background = state.cfg.useRealApi ? '#22c55e22' : '#a78bfa22';
      el.modePill.style.border = '1px solid ' + (state.cfg.useRealApi ? '#22c55e55' : '#a78bfa55');
      el.modePill.style.color = state.cfg.useRealApi ? '#86efac' : '#ddd6fe';
    }

    function pushChart(valueW){
      const maxPoints = 60;
      state.chart.push(valueW);
      if (state.chart.length > maxPoints) state.chart.shift();
      const w = 360, h = 120, maxWatt = state.cfg.maxPower || 5000;
      const n = state.chart.length;
      if (n === 0){ el.chartPath.setAttribute('d',''); return; }
      const step = w / Math.max(1, maxPoints-1);
      let d = '';
      state.chart.forEach((v,i)=>{
        const x = i * step;
        const y = h - Math.max(0, Math.min(1, v / maxWatt)) * h;
        d += (i===0? `M ${x} ${y}` : ` L ${x} ${y}`);
      });
      d += ` L ${w} ${h} L 0 ${h} Z`;
      el.chartPath.setAttribute('d', d);
    }

    function updateSafetyUI(){
      const lockIcon = document.getElementById('lockIcon');
      const isOn = state.safety;
      el.btnSafety.classList.toggle('btn-danger', isOn);
      el.btnSafety.classList.toggle('btn-primary', !isOn);
      el.btnSafety.textContent = '';
      el.btnSafety.appendChild(lockIcon);
      el.btnSafety.append(isOn ? ' قفل ایمنی فعال' : ' قفل ایمنی باز');
      document.querySelectorAll('[data-action]').forEach(b=> b.disabled = isOn);
      if (el.safetyBanner) el.safetyBanner.classList.toggle('hidden', !isOn);
    }

    // --- Routing (tabs) ---
    const screens = {
      dashboard: el.scrDash,
      controls: el.scrCtrl,
      logs: el.scrLogs,
      connections: el.scrConnections,
      settings: el.scrSettings
    };
    function showScreen(name){
      Object.keys(screens).forEach(k=>{
        screens[k].classList.toggle('tab-hide', k !== name);
      });
      document.querySelectorAll('.nav-item').forEach(b=>{
        b.classList.toggle('active', b.getAttribute('data-nav') === name);
      });
      if (name === 'controls') updateSafetyUI();
      if (name === 'logs') applyLogFilters();
    }

    // --- Modal ---
    const modal = { open:false, action:null, meta:null };
    function openModal(action, metaText){
      modal.open = true; modal.action = action; modal.meta = metaText || '';
      document.getElementById('modalAction').textContent = metaText || action;
      document.getElementById('chkConfirm').checked = false;
      document.getElementById('txtNote').value = '';
      document.getElementById('modalErr').classList.add('hidden');
      el.modal.classList.remove('hidden'); el.modal.classList.add('flex');
    }
    function closeModal(){
      modal.open = false; modal.action = null; modal.meta = null;
      el.modal.classList.add('hidden'); el.modal.classList.remove('flex');
    }
    async function executeAction(){
      if (!document.getElementById('chkConfirm').checked){
        document.getElementById('modalErr').classList.remove('hidden'); return;
      }
      const act = modal.action;
      const note = document.getElementById('txtNote').value.trim();
      const metaText = modal.meta || act;
      let type='cmd';

      // حالت API واقعی
      if (state.cfg.useRealApi && state.cfg.apiBase){
        showToast('در حال ارسال فرمان...','warn');
        try{
          const res = await sendCommand(act, note);
          const ok = !!res.ok;
          if (ok && res.state){
            if (typeof res.state.grid === 'string') state.grid = res.state.grid;
            if (typeof res.state.inverter === 'string') state.inverter = res.state.inverter;
            if (typeof res.state.powerTarget === 'number') state.powerTarget = res.state.powerTarget;
            if (typeof res.state.irradiance === 'number') state.irradiance = res.state.irradiance;
            if (typeof res.state.temp === 'number') state.temp = res.state.temp;
          } else if (ok && act === 'set_power'){
            const v = Number(el.inpPower.value || 0);
            state.powerTarget = Math.max(0, Math.min(state.cfg.maxPower, v));
          }
          addLog(metaText, ok ? 'موفق' : 'ناموفق', note, ok ? 'cmd' : 'err');
          updateOverview();
          closeModal();
          showToast(ok ? 'فرمان ارسال شد' : 'ارسال ناموفق بود', ok ? 'ok' : 'err');
        }catch(e){
          addLog(metaText, 'ناموفق', note, 'err');
          closeModal();
          showToast('ارسال ناموفق بود','err');
        }
        return;
      }

      // حالت شبیه‌ساز
      if (act === 'cut_grid'){
        state.grid = 'قطع';
        state.powerTarget = Math.min(state.powerTarget, 2000);
      } else if (act === 'inv_fault'){
        state.inverter = 'معیوب';
        state.powerTarget = 0;
        type = 'warn';
      } else if (act === 'reduce_power'){
        state.powerTarget = 1200;
      } else if (act === 'reset'){
        state.grid = 'متصل';
        state.inverter = 'سالم';
        state.powerTarget = 4200;
      } else if (act === 'set_power'){
        const v = Number(el.inpPower.value || 0);
        state.powerTarget = Math.max(0, Math.min(state.cfg.maxPower, v));
      }
      addLog(metaText, 'انجام شد', note, type);
      closeModal();
      updateOverview();
      showToast(`${metaText} ثبت شد`, 'ok');
    }

    // --- Alarms ---
    function setAlarm(id, title, type='warn'){
      if (state.alarms.active.find(a=>a.id===id)) return;
      state.alarms.active.push({id,title,type});
      addLog('آلارم', title, '', type);
      refreshAlarmUI();
      if (state.cfg.autosave) saveLocal();
    }
    function clearAlarm(id){
      const i = state.alarms.active.findIndex(a=>a.id===id);
      if (i>-1){
        const title = state.alarms.active[i].title;
        state.alarms.active.splice(i,1);
        addLog('برطرف شد', title, '', 'info');
        refreshAlarmUI();
        if (state.cfg.autosave) saveLocal();
      }
    }
    function refreshAlarmUI(){
      const has = state.alarms.active.length>0 && !state.alarms.muted;
      el.alarmBanner.classList.toggle('hidden', !has);
      if (has){
        const txt = state.alarms.active.map(a=>a.title).join(' • ');
        el.alarmText.textContent = txt;
      }
    }

    // --- Telemetry simulation ---
    let tickTimer = null;
    function telemetryTick(){
      const envDrift = (Math.random()-0.5)*0.35;
      state.temp = Math.max(10, Math.min(80, state.temp + envDrift));

      const invOk = (state.inverter === 'سالم');
      const gridOk = (state.grid === 'متصل');
      let maxAvail = (state.cfg.maxPower || 5000) * state.irradiance;
      if (!invOk) maxAvail = 0;
      if (!gridOk) maxAvail = Math.min(maxAvail, 2000);

      const target = Math.min(state.powerTarget, maxAvail);
      const diff = target - state.powerNow;
      state.powerNow += diff * 0.22 + (Math.random()-0.5)*25;
      state.powerNow = Math.max(0, state.powerNow);

      if (state.temp >= state.cfg.tempAlarm) setAlarm('temp', `دما بالا (${Math.round(state.temp)}°C)`, 'warn'); else clearAlarm('temp');
      if (!gridOk) setAlarm('grid', 'شبکه قطع است', 'warn'); else clearAlarm('grid');
      if (!invOk) setAlarm('inv', 'اینورتر معیوب', 'warn'); else clearAlarm('inv');

      pushChart(state.powerNow);
      updateOverview();
    }
    function startTick(){
      stopTick();
      if (state.cfg.useRealApi && state.cfg.apiBase){
        // اگر API واقعی فعال است، Polling سبک
        tickTimer = setInterval(fetchRealtime, Math.max(800, state.cfg.tickMs));
      } else {
        tickTimer = setInterval(telemetryTick, state.cfg.tickMs);
      }
    }
    function stopTick(){
      if (tickTimer) clearInterval(tickTimer);
      tickTimer = null;
    }

    // --- Persistence ---
    function saveLocal(){
      try{
        const data = {
          cfg: state.cfg,
          safety: state.safety,
          powerTarget: state.powerTarget,
          irradiance: state.irradiance
        };
        localStorage.setItem('solar_demo_v3', JSON.stringify(data));
      }catch(e){}
    }
    function loadLocal(){
      try{
        const raw = localStorage.getItem('solar_demo_v3');
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.cfg) Object.assign(state.cfg, data.cfg);
        if (typeof data.safety==='boolean') state.safety = data.safety;
        if (typeof data.powerTarget==='number') state.powerTarget = data.powerTarget;
        if (typeof data.irradiance==='number') state.irradiance = data.irradiance;
      }catch(e){}
    }

    // --- CSV Download ---
    function downloadCSV(){
      const header = ['زمان','نوع','عملیات','نتیجه','توضیح'];
      const rows = state.logs.map(e => [
        e.t.toLocaleString('fa-IR'), e.type, e.action, e.result, (e.note||'').replace(/\n/g,' ')
      ]);
      const all = [header, ...rows].map(r => r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob(["\ufeff"+all], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'solar_logs.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('فایل لاگ دانلود شد','ok');
    }

    // --- Real API integration (REST + optional WS) ---
    async function fetchRealtime(){
      try{
        const base = state.cfg.apiBase.replace(/\/$/, '');
        const r = await fetch(base + '/status', { method:'GET' });
        if (!r.ok) throw new Error('bad status');
        const data = await r.json();
        // انتظار: { grid, inverter, powerNow, irradiance, temp, powerTarget }
        if (typeof data.grid === 'string') state.grid = data.grid;
        if (typeof data.inverter === 'string') state.inverter = data.inverter;
        if (typeof data.powerNow === 'number') state.powerNow = data.powerNow;
        if (typeof data.irradiance === 'number') state.irradiance = data.irradiance;
        if (typeof data.temp === 'number') state.temp = data.temp;
        if (typeof data.powerTarget === 'number') state.powerTarget = data.powerTarget;
        pushChart(state.powerNow);
        updateOverview();
      }catch(e){
        // خطا در دریافت زنده را فقط لاگ نرم کنیم که مزاحم نشود
        addLog('دریافت وضعیت', 'ناموفق', '', 'warn');
      }
    }

    async function sendCommand(act, note){
      const base = state.cfg.apiBase.replace(/\/$/, '');
      const payload = { action: act, note, ts: Date.now() };
      const r = await fetch(base + '/command', {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) return { ok:false };
      try{ return await r.json(); }catch{ return { ok:true }; }
    }

    // Optional: Basic WS subscribe (if provided)
    let ws = null;
    function openWS(){
      if (!state.cfg.wsUrl) return;
      try{
        ws = new WebSocket(state.cfg.wsUrl);
        ws.onopen = ()=>{ addLog('WS','متصل', state.cfg.wsUrl, 'info'); };
        ws.onclose = ()=>{ addLog('WS','قطع شد', '', 'warn'); };
        ws.onerror = ()=>{ addLog('WS','خطا', '', 'err'); };
        ws.onmessage = (ev)=>{
          try{
            const msg = JSON.parse(ev.data);
            if (msg.type === 'telemetry'){
              if (typeof msg.data.powerNow === 'number') state.powerNow = msg.data.powerNow;
              if (typeof msg.data.temp === 'number') state.temp = msg.data.temp;
              if (typeof msg.data.grid === 'string') state.grid = msg.data.grid;
              if (typeof msg.data.inverter === 'string') state.inverter = msg.data.inverter;
              pushChart(state.powerNow); updateOverview();
            } else if (msg.type === 'alarm'){
              setAlarm(msg.id || ('ws_'+Date.now()), msg.title || 'آلارم', msg.severity||'warn');
            }
          }catch(err){}
        };
      }catch(e){ addLog('WS','عدم امکان اتصال', '', 'err'); }
    }
    function closeWS(){ try{ ws && ws.close(); }catch(e){} ws=null; }

    // --- Connections helpers (UI <-> state) ---
    function fillConnectionsUI(){
      // generic API fields
      el.chkUseReal.checked = !!state.cfg.useRealApi;
      el.inpApiBase.value = state.cfg.apiBase || '';
      el.inpWsUrl.value = state.cfg.wsUrl || '';
      // protocol cards
      ['modbus','iec61850','opcua','dnp3','iec104','mqtt'].forEach(proto=>{
        const conf = state.cfg.connections[proto] || {};
        const card = document.querySelector(`[data-conn-card="${proto}"]`);
        const form = document.querySelector(`[data-conn-form="${proto}"]`);
        const en = document.querySelector(`[data-conn-enabled="${proto}"]`);
        const st = document.getElementById(`st_${proto}`);
        if (en) en.checked = !!conf.enabled;
        if (st) st.textContent = conf.enabled ? 'فعال' : 'غیرفعال';
        if (!form) return;
        form.querySelectorAll('[data-conn-field]').forEach(inp=>{
          const key = inp.getAttribute('data-conn-field');
          if (key in conf) inp.value = conf[key];
          else inp.value = '';
        });
      });
      updateOverview();
    }

    function readConnForm(proto){
      const form = document.querySelector(`[data-conn-form="${proto}"]`);
      if (!form) return {};
      const out = {};
      form.querySelectorAll('[data-conn-field]').forEach(inp=>{
        const key = inp.getAttribute('data-conn-field');
        const val = (inp.type==='number') ? Number(inp.value) : inp.value;
        out[key] = val;
      });
      return out;
    }

    function setConnEnabled(proto, enabled){
      const conf = state.cfg.connections[proto] || {};
      conf.enabled = !!enabled;
      state.cfg.connections[proto] = conf;
      const st = document.getElementById(`st_${proto}`);
      if (st) st.textContent = conf.enabled ? 'فعال' : 'غیرفعال';
      if (state.cfg.autosave) saveLocal();
    }

    function mockTestConnection(proto, conf){
      // تست شبیه‌سازی: اگر فیلد کلیدی خالی باشد، شکست
      let hasKey = false;
      if (proto==='modbus') hasKey = !!conf.host;
      else if (proto==='opcua') hasKey = !!conf.endpoint;
      else if (proto==='mqtt') hasKey = !!conf.broker && !!conf.topic;
      else if (proto==='iec61850') hasKey = !!conf.host;
      else if (proto==='dnp3') hasKey = !!conf.outstation;
      else if (proto==='iec104') hasKey = !!conf.host;
      const success = hasKey && Math.random() > 0.1;
      return new Promise(res=>{
        setTimeout(()=> res({ ok: success, msg: success ? 'اتصال برقرار شد (شبیه‌ساز)' : 'عدم موفقیت در اتصال (شبیه‌ساز)' }), 700);
      });
    }

    // --- Events ---
    // bottom nav
    el.navButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const name = btn.getAttribute('data-nav');
        showScreen(name);
      });
    });

    // safety
    el.btnSafety.addEventListener('click', ()=>{
      state.safety = !state.safety;
      updateSafetyUI();
      if (state.cfg.autosave) saveLocal();
      showScreen('controls');
      showToast(state.safety ? 'قفل ایمنی فعال شد' : 'قفل ایمنی باز شد', state.safety ? 'warn' : 'ok');
    });

    // command buttons
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      if (state.safety){ showToast('قفل ایمنی فعال است. ابتدا قفل را باز کنید.','warn'); return; }
      const act = btn.getAttribute('data-action');
      const titleMap = {
        cut_grid: 'قطع اتصال شبکه',
        inv_fault: 'خطای اینورتر',
        reduce_power: 'کاهش توان به ۱۲۰۰W',
        reset: 'ریست سیستم'
      };
      openModal(act, titleMap[act] || act);
    });

    // modal
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalCancel').addEventListener('click', closeModal);
    document.getElementById('modalOk').addEventListener('click', executeAction);

    // slider
    el.rngIrr.addEventListener('input', ()=>{
      const v = Number(el.rngIrr.value)/100;
      state.irradiance = Math.max(0, Math.min(1, v));
      el.txtIrr.textContent = `${Math.round(state.irradiance*100)}٪`;
      if (state.cfg.autosave) saveLocal();
    });

    // logs actions
    if (el.btnDownload) el.btnDownload.addEventListener('click', (evt)=>{ evt.preventDefault(); downloadCSV(); });
    if (el.btnClearLog) el.btnClearLog.addEventListener('click', (evt)=>{ evt.preventDefault(); state.logs = []; el.logList.innerHTML=''; showToast('لاگ پاک شد','warn'); });
    if (el.btnCopyLog) el.btnCopyLog.addEventListener('click', async ()=>{
      try{
        const txt = state.logs.map(e => `[${e.t.toLocaleString('fa-IR')}] (${e.type}) ${e.action} => ${e.result}${e.note? ' | '+e.note:''}`).join('\n');
        await navigator.clipboard.writeText(txt || 'لاگی وجود ندارد');
        showToast('لاگ در کلیپ‌بورد کپی شد','ok');
      }catch(e){ showToast('کپی ناموفق بود','err'); }
    });

    // settings events
    function syncSettingsUI(){
      el.inpSite.value = state.cfg.siteName;
      el.lblTick.textContent = state.cfg.tickMs;
      el.rngTick.value = state.cfg.tickMs;
      el.lblMaxPower.textContent = `${state.cfg.maxPower} W`;
      el.rngMaxPower.value = state.cfg.maxPower;
      el.lblTempAlarm.textContent = `${state.cfg.tempAlarm}°C`;
      el.rngTempAlarm.value = state.cfg.tempAlarm;
      el.chkAutosave.checked = !!state.cfg.autosave;
      // connections
      el.chkUseReal.checked = !!state.cfg.useRealApi;
      el.inpApiBase.value = state.cfg.apiBase || '';
      el.inpWsUrl.value = state.cfg.wsUrl || '';
      fillConnectionsUI();
    }
    el.inpSite.addEventListener('input', ()=>{ state.cfg.siteName = el.inpSite.value; updateOverview(); if (state.cfg.autosave) saveLocal(); });
    el.rngTick.addEventListener('input', ()=>{ state.cfg.tickMs = Number(el.rngTick.value); el.lblTick.textContent = state.cfg.tickMs; startTick(); if (state.cfg.autosave) saveLocal(); });
    el.rngMaxPower.addEventListener('input', ()=>{ state.cfg.maxPower = Number(el.rngMaxPower.value); el.lblMaxPower.textContent = `${state.cfg.maxPower} W`; if (state.cfg.autosave) saveLocal(); });
    el.rngTempAlarm.addEventListener('input', ()=>{ state.cfg.tempAlarm = Number(el.rngTempAlarm.value); el.lblTempAlarm.textContent = `${state.cfg.tempAlarm}°C`; if (state.cfg.autosave) saveLocal(); });
    el.chkAutosave.addEventListener('change', ()=>{ state.cfg.autosave = el.chkAutosave.checked; if (state.cfg.autosave) saveLocal(); });

    el.btnExportCfg.addEventListener('click', ()=>{
      const data = { cfg: state.cfg };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'solar_config.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('تنظیمات خروجی شد','ok');
    });
    el.fileImport.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if (data.cfg) Object.assign(state.cfg, data.cfg);
          syncSettingsUI(); updateOverview(); startTick(); saveLocal();
          showToast('تنظیمات وارد شد','ok');
        }catch(err){ showToast('فایل نامعتبر است','err'); }
        el.fileImport.value = '';
      };
      reader.readAsText(file);
    });
    el.btnResetCfg.addEventListener('click', ()=>{
      state.cfg = {
        siteName:'کنترل خورشیدی (موبایل)', tickMs:1200, maxPower:5000, tempAlarm:60, autosave:true,
        useRealApi:false, apiBase:'', wsUrl:'',
        connections: {
          modbus:{enabled:false,host:'',port:502,unitId:1,mode:'tcp'},
          iec61850:{enabled:false,host:'',port:102,ied:'',ld:''},
          opcua:{enabled:false,endpoint:''},
          dnp3:{enabled:false,outstation:'',master:'',port:20000},
          iec104:{enabled:false,host:'',port:2404,asdu:1},
          mqtt:{enabled:false,broker:'',topic:''}
        }
      };
      syncSettingsUI(); updateOverview(); startTick(); saveLocal(); showToast('تنظیمات بازنشانی شد','warn');
    });

    // connections events
    el.chkUseReal.addEventListener('change', ()=>{
      state.cfg.useRealApi = el.chkUseReal.checked;
      updateOverview();
      if (state.cfg.autosave) saveLocal();
      closeWS(); if (state.cfg.useRealApi) openWS(); startTick();
      showToast(state.cfg.useRealApi ? 'حالت API واقعی فعال شد' : 'حالت شبیه‌ساز فعال شد', state.cfg.useRealApi ? 'ok' : 'warn');
    });
    el.btnApiSave.addEventListener('click', ()=>{
      state.cfg.apiBase = el.inpApiBase.value.trim();
      state.cfg.wsUrl = el.inpWsUrl.value.trim();
      if (state.cfg.autosave) saveLocal();
      closeWS(); openWS(); startTick();
      showToast('آدرس‌های API ذخیره شد و وضعیت به‌روز شد','ok');
    });
    el.btnApiTest.addEventListener('click', async ()=>{
      const base = el.inpApiBase.value.trim();
      if (!base){ showToast('آدرس API را وارد کنید','warn'); return; }
      showToast('در حال تست API...','warn');
      try{
        const r = await fetch(base.replace(/\/$/, '') + '/health', { method:'GET' });
        if (!r.ok) throw new Error('bad');
        const info = await r.json().catch(()=>({ok:true}));
        addLog('تست API','موفق', base, 'cmd');
        showToast('اتصال برقرار شد','ok');
      }catch(e){
        addLog('تست API','ناموفق', base, 'warn');
        showToast('اتصال برقرار نشد','err');
      }
    });

    // enable toggles
    document.querySelectorAll('[data-conn-enabled]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const proto = chk.getAttribute('data-conn-enabled');
        setConnEnabled(proto, chk.checked);
      });
    });

    // save/test buttons via delegation
    document.addEventListener('click', async (e)=>{
      const testBtn = e.target.closest('[data-conn-test]');
      const saveBtn = e.target.closest('[data-conn-save]');
      if (testBtn){
        const proto = testBtn.getAttribute('data-conn-test');
        const formVals = readConnForm(proto);
        showToast('در حال تست اتصال...','warn');
        const r = await mockTestConnection(proto, formVals);
        addLog(`تست اتصال ${proto.toUpperCase()}`, r.ok ? 'موفق' : 'ناموفق', '', r.ok ? 'cmd' : 'warn');
        showToast(r.msg, r.ok ? 'ok' : 'err');
      }
      if (saveBtn){
        const proto = saveBtn.getAttribute('data-conn-save');
        const vals = readConnForm(proto);
        state.cfg.connections[proto] = { ...(state.cfg.connections[proto]||{}), ...vals };
        fillConnectionsUI();
        if (state.cfg.autosave) saveLocal();
        addLog(`ذخیره تنظیمات ${proto.toUpperCase()}`, 'ثبت شد', '', 'cmd');
        showToast('تنظیمات ذخیره شد','ok');
      }
    });

    document.getElementById('btnMuteAlarms')?.addEventListener('click', ()=>{
      state.alarms.muted = !state.alarms.muted;
      refreshAlarmUI();
      showToast(state.alarms.muted ? 'آلارم‌ها بی‌صدا شدند' : 'آلارم‌ها فعال شدند', 'warn');
    });

    // --- Install prompt (PWA-like) ---
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBar').classList.remove('hidden');
    });
    document.getElementById('btnDismissInstall')?.addEventListener('click', ()=>{
      document.getElementById('installBar').classList.add('hidden');
    });
    document.getElementById('btnInstall')?.addEventListener('click', async ()=>{
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') showToast('برنامه به صفحه‌اصلی اضافه شد','ok');
      document.getElementById('installBar').classList.add('hidden');
      deferredPrompt = null;
    });

    // --- Init ---
    loadLocal();
    syncSettingsUI();
    updateSafetyUI();
    updateOverview();
    for (let i=0;i<24;i++){ pushChart(4200 - i*25); }
    addLog('راه‌اندازی سیستم','آماده', '', 'info');
    startTick();
    showScreen('dashboard');
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98228fb6c79ef0e4',t:'MTc1ODM4NDI5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>